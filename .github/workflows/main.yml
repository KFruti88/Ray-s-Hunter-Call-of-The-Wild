name: Sync Trophy Stats
on:
  schedule:
    - cron: '*/10 * * * *' # Runs every 10 minutes
  workflow_dispatch: # Allows manual trigger

permissions:
  contents: write # Grants bot permission to save changes

jobs:
  sync-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Sync StreamElements Data
        run: |
          ACC_ID="683d5f784b7b70b6bf43aacb"

          sync_counter() {
            JSON_ID=$1
            COMMAND=$2
            RAW=$(curl -s "https://api.streamelements.com/static/v2/channels/$ACC_ID/counters/$COMMAND")
            VAL=$(echo $RAW | jq -r '.value // 0') # Null safety
            
            if [ "$VAL" != "0" ] && [ "$VAL" != "null" ]; then
              jq --arg id "$JSON_ID" --arg val "$VAL" '(.[] | select(.id == $id) | .current) = ($val | tonumber)' trophies.json > temp.json && mv temp.json trophies.json
            fi
          }

          # Syncing all your active grinds
          sync_counter "spturkey" "spturkey"
          sync_counter "rcrocodile" "rcrocodile"
          sync_counter "rbanteng" "rbanteng"
          sync_counter "rlevel" "rlevel"
          sync_counter "rpaleo" "rpaleo"
          sync_counter "rart" "rart"

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "actions@github.com"
          git add trophies.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Automated sync: $(date)" && git push)
