name: Sync Trophy Stats
on:
  schedule:
    - cron: '*/10 * * * *' # Runs every 10 minutes
  workflow_dispatch: # Allows manual run

permissions:
  contents: write

jobs:
  sync-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Sync StreamElements Data
        run: |
          # 1. FETCH TURKEY DATA
          TURKEY_RAW=$(curl -s "https://api.streamelements.com/static/v2/channels/683d5f784b7b70b6bf43aacb/counters/spturkey")
          # Extract value; if null or missing, default to 0
          TURKEY_VAL=$(echo $TURKEY_RAW | jq -r '.value // 0')

          # 2. UPDATE TURKEY IN JSON
          if [ "$TURKEY_VAL" != "0" ]; then
            jq --arg val "$TURKEY_VAL" '(.[] | select(.id == "spturkey") | .current) = ($val | tonumber)' trophies.json > temp.json && mv temp.json trophies.json
          fi

          # 3. FETCH CROCODILE DATA (Optional extra example)
          CROC_RAW=$(curl -s "https://api.streamelements.com/static/v2/channels/683d5f784b7b70b6bf43aacb/counters/rcrocodile")
          CROC_VAL=$(echo $CROC_RAW | jq -r '.value // 0')
          
          if [ "$CROC_VAL" != "0" ]; then
            jq --arg val "$CROC_VAL" '(.[] | select(.id == "rcrocodile") | .current) = ($val | tonumber)' trophies.json > temp.json && mv temp.json trophies.json
          fi

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "actions@github.com"
          git add trophies.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Automated sync: $(date)" && git push)
